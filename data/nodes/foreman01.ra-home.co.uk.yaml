---
# Node-specific configuration for foreman.ra-home.co.uk (Foreman ENC server)
# Migrated from pi.ra-home.co.uk on <DATE>

# Base profile settings
profile::base::manage_firewall: true
profile::base::manage_logrotate: true
profile::base::manage_unattended_upgrades: true
profile::base::manage_ssh_hardening: true

# Puppet Agent - Disabled because this node IS the Puppet Server
# Puppet configuration is managed via profile::foreman instead
profile::puppet_agent::manage_agent: false

# PostgreSQL Database Configuration
profile::postgresql::manage_postgresql: true
profile::postgresql::postgres_version: '13'
profile::postgresql::listen_addresses: 'localhost'
profile::postgresql::port: 5432
profile::postgresql::manage_firewall: false  # localhost only, no external access

# Performance tuning for 8GB RAM VPS
profile::postgresql::shared_buffers: '2GB'        # 25% of RAM
profile::postgresql::effective_cache_size: '6GB'  # 75% of RAM
profile::postgresql::work_mem: '64MB'
profile::postgresql::maintenance_work_mem: '512MB'
profile::postgresql::max_connections: 200

profile::postgresql::databases:
  foreman:
    owner: foreman
    encoding: UTF8
    locale: en_US.UTF-8
  # puppetdb database is managed by puppetlabs-puppetdb module

profile::postgresql::database_users:
  foreman:
    password: 'ENC[PKCS7,MIIBeQYJKoZIhvcNAQcDoIIBajCCAWYCAQAxggEhMIIBHQIBADAFMAACAQAwDQYJKoZIhvcNAQEBBQAEggEARTA3cU6AmDX8cbahBhJV1zMqgNL+A//t3NxF2H2u57p87RyBbC6DdR9YX/PtccMcRRCZcb78dU7HrU2Wxw3bojwJDzMYoeTqz4vPcOFG0J01H5IyVKlsHr0Bbi2NudOROQiQduqIVmE83odjhtOJGUQUAblE5uXD+mBQ7e61no5ihnDx7zGNKqf/L+JLYJ6+CkXkBnwZZf+rAvsapdFiCe4YOtb+Vcls875H8FlP/3TLC2MeHk0nM6/ep/cYuaSWKtgj0ABZnMLxJ5FflQ4KxH+vsu9Ju7ga3ND58DkXH6y4nach5NGFjuIltiA/dxUHi4sqgIQhqgMDa6iMZhM+ijA8BgkqhkiG9w0BBwEwHQYJYIZIAWUDBAEqBBCdjc/UFCM6RgIfHirj4fUvgBAv+qlb8A2mKqX+ccylLEzP]'
  # puppetdb and puppetdb-read users managed via Foreman ENC

profile::postgresql::database_grants:
  foreman_db_access:
    privilege: ALL
    db: foreman
    role: foreman
  # puppetdb grants managed via Foreman ENC

# pg_hba rules for TCP connections from localhost
# puppetdb pg_hba rules managed via Foreman ENC

# PuppetDB Configuration - All settings managed via Foreman ENC

# Foreman Server Configuration
profile::foreman::manage_foreman: true
profile::foreman::foreman_version: '3.12'  # Stable version with full Rocky Linux 9 support (EL9 support started in 3.11)
profile::foreman::server_fqdn: 'foreman01.ra-home.co.uk'

profile::foreman::admin_username: 'admin'
profile::foreman::admin_password: 'ENC[PKCS7,MIIBeQYJKoZIhvcNAQcDoIIBajCCAWYCAQAxggEhMIIBHQIBADAFMAACAQAwDQYJKoZIhvcNAQEBBQAEggEAeQlPpKiNWrDsnk0BePZS9Kjn/6tjQdVgdAPRXIkVgqk0XXiocmYYmnMVH70j682PnhIhudLD2MBTcOVjJH+jJyTZcXtqcyVjhzuGHk3g5PZVeZnkWt11QwYWs30/o+yihOmL81DlnLDc9nbI8S61HDsDMC3SxmZD7nClr/Wh8/7oyRUpbfO+dSVmtPF0JnC0TxIsThAoVm2A+GRK3IczD+1pw9RU/NWnsqKLSf68LcN9Q/PcShXJwNBe9c1JYPZj+rz86RgiAF3piF1R8dkbOEvsJLHMaFXW5tC9mQ8plnmmJpKFqGIJxf+uGpZqMh9LLUt28SfBzwrVCdjjrVtv9TA8BgkqhkiG9w0BBwEwHQYJYIZIAWUDBAEqBBA8uEmF1dGYV87X5QY2JRP5gBD2Wp7ua7VTHY2+aAGm65dO]'
profile::foreman::db_host: 'localhost'
profile::foreman::db_database: 'foreman'
profile::foreman::db_username: 'foreman'

# TODO: Copy encrypted password from data/nodes/pi.ra-home.co.uk.yaml (must match database_users.foreman.password)
profile::foreman::db_password: 'ENC[PKCS7,MIIBeQYJKoZIhvcNAQcDoIIBajCCAWYCAQAxggEhMIIBHQIBADAFMAACAQAwDQYJKoZIhvcNAQEBBQAEggEARTA3cU6AmDX8cbahBhJV1zMqgNL+A//t3NxF2H2u57p87RyBbC6DdR9YX/PtccMcRRCZcb78dU7HrU2Wxw3bojwJDzMYoeTqz4vPcOFG0J01H5IyVKlsHr0Bbi2NudOROQiQduqIVmE83odjhtOJGUQUAblE5uXD+mBQ7e61no5ihnDx7zGNKqf/L+JLYJ6+CkXkBnwZZf+rAvsapdFiCe4YOtb+Vcls875H8FlP/3TLC2MeHk0nM6/ep/cYuaSWKtgj0ABZnMLxJ5FflQ4KxH+vsu9Ju7ga3ND58DkXH6y4nach5NGFjuIltiA/dxUHi4sqgIQhqgMDa6iMZhM+ijA8BgkqhkiG9w0BBwEwHQYJYIZIAWUDBAEqBBCdjc/UFCM6RgIfHirj4fUvgBAv+qlb8A2mKqX+ccylLEzP]'

profile::foreman::enable_puppetserver: true
profile::foreman::enable_enc: true
profile::foreman::enable_reports: true

profile::foreman::initial_organization:
  name: 'RA Home'
  description: 'Home Infrastructure'

profile::foreman::initial_location:
  name: 'Home Network'
  description: 'Home network infrastructure'

# Foreman Smart Proxy Configuration
profile::foreman_proxy::manage_proxy: true
profile::foreman_proxy::foreman_base_url: 'https://foreman01.ra-home.co.uk'
profile::foreman_proxy::register_in_foreman: true  # OAuth credentials updated
profile::foreman_proxy::manage_dns: true
profile::foreman_proxy::dns_provider: 'nsupdate'
profile::foreman_proxy::dns_server: '127.0.0.1'
profile::foreman_proxy::dns_ttl: 86400
profile::foreman_proxy::manage_dhcp: false
profile::foreman_proxy::manage_tftp: false
profile::foreman_proxy::manage_puppet: true

# TODO: Generate NEW OAuth credentials (don't copy from Pi - security best practice)
# Run: uuidgen | eyaml encrypt -s
profile::foreman_proxy::oauth_consumer_key: 'ENC[PKCS7,MIIBmQYJKoZIhvcNAQcDoIIBijCCAYYCAQAxggEhMIIBHQIBADAFMAACAQAwDQYJKoZIhvcNAQEBBQAEggEAvabbVlxnod1hLqwn/RD5RKiq1Nm2QCmPWyYNrkT2v7/l0YLtH7hRNf0ZRGA7AEsXRNb3xbVaA/bjU8iMdpAugVIEKg1GllF/m/Ka6VDy0SN2f3e2Slk5O2hxSMRVFpKm35Hzp2ey7HFr84x2CJ5wZQg4U1bokNS/fYAyWrLZGlN6Amr1ibFNgToycmg6MY4x425eeJkcqWvY4m67ZKH8H7JcW/TJcL22c4D8ec1n8HLw5xow2j/+etF2K6yoA4Xc4xHnQQoayPKTtiQ5b+XaVTbVHpBesGXMNtiTcp4GfzOM68Hu7VxuA/D2LDgfja2njmGF3+pm4UjAfCCXiTlQTTBcBgkqhkiG9w0BBwEwHQYJYIZIAWUDBAEqBBBxZY2YLAZ4avjktOntFE/RgDAQCDdIbdVbuYvFoiQHdMSYZmoLS4ICza5JjpFXxFchbwzperO29zzVTAN2XbhKXf0=]'
profile::foreman_proxy::oauth_consumer_secret: 'ENC[PKCS7,MIIBmQYJKoZIhvcNAQcDoIIBijCCAYYCAQAxggEhMIIBHQIBADAFMAACAQAwDQYJKoZIhvcNAQEBBQAEggEAIhQ/3JKzabjXUH8uqEdyMWuEZhDm2JCINCehxSPH0v9MwqQiCqkt7u3XsWky0neRWjF6pVM6pzRe48fnJvD4PWnXSDyyQXGg4BPBmn2v2oNcstjJ/09tL53xwLzxA0o4UvHW8kYmazphYusASRSNliXvyF4pNWt9lGSsimHJuF6w6IPQDqQJ5UezeQyry5YtK1odZX/n55dnXeD70TE0ZYApENDab7Y1jePRBSaxpYC2uqDobAv+kJYE9sZragDKlR2AI5M0dmRKczBEpDz9p7Mi1plTDTUrS/18RcFyNM5+qsOQUu5RbczXcmXoZFn0XF98U+wOogwqR9w358Q+SjBcBgkqhkiG9w0BBwEwHQYJYIZIAWUDBAEqBBBhb5K7Q4OXEPYXlqU5DhA4gDDNNeR7KBakIbo7zzN3W7AGoEpYBIgTYoG71YsovOd1HYLlITvXnVpPWye9PDaFOHc=]'

# R10k Configuration - Deploys Puppet control repository
profile::r10k::manage_r10k: true
profile::r10k::git_remote: 'https://github.com/ryana-0154/infra-puppet-control.git'
profile::r10k::basedir: '/etc/puppetlabs/code/environments'
profile::r10k::cachedir: '/var/cache/r10k'
profile::r10k::auto_deploy: true  # Deploy on first run
profile::r10k::manage_cron: false  # Manual deployments via Puppet runs for now

# Firewall Rules (accessible from VPN network)
profile::firewall::custom_rules:
  foreman_https:
    port: 443
    proto: tcp
    source: '10.10.10.0/24'
    jump: accept
  foreman_http:
    port: 80
    proto: tcp
    source: '10.10.10.0/24'
    jump: accept
  puppetserver:
    port: 8140
    proto: tcp
    source: '10.10.10.0/24'
    jump: accept
  foreman_proxy:
    port: 8443
    proto: tcp
    source: '10.10.10.0/24'
    jump: accept

# ACME configuration managed via Foreman ENC Smart Class Parameters
# See: Configure → Puppet Classes → profile::acme_server → Smart Class Parameters
