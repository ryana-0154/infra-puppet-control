#cloud-config
# Base cloud-init configuration for Puppet-managed hosts
# This template installs and configures Puppet agent, sets up SSH, and applies basic hardening.
#
# CUSTOMIZE BEFORE USE:
#   1. Replace YOUR_HOSTNAME with actual hostname
#   2. Replace YOUR_SSH_PUBLIC_KEY_HERE with your SSH public key
#   3. Adjust username if needed (default: ryan)
#   4. Review and adjust Puppet server settings

hostname: YOUR_HOSTNAME
fqdn: YOUR_HOSTNAME.ra-home.co.uk
manage_etc_hosts: true

# Datasource configuration (NoCloud for bare metal/VM/local configs)
datasource_list: [NoCloud, None]

# Explicitly disable problematic cloud modules
cloud_config_modules:
  - migrator
  - bootcmd
  - write-files
  - growpart
  - resizefs
  - disk_setup
  - mounts
  - set_hostname
  - update_hostname
  - update_etc_hosts
  - ca-certs
  - rsyslog
  - users-groups
  # REMOVED: disable-ec2-metadata (not needed for non-AWS)
  - ssh

cloud_final_modules:
  - package-update-upgrade-install
  - scripts-vendor
  - scripts-per-once
  - scripts-per-boot
  - scripts-per-instance
  - scripts-user
  - ssh-authkey-fingerprints
  - keys-to-console
  - phone-home
  - final-message
  - power-state-change

# User configuration
users:
  - name: ryan
    groups: [sudo, wheel]
    sudo: ['ALL=(ALL) NOPASSWD:ALL']
    shell: /bin/bash
    ssh_authorized_keys:
      - YOUR_SSH_PUBLIC_KEY_HERE

# Disable root login via SSH (security hardening)
ssh_pwauth: false
disable_root: false  # Keep root enabled for initial setup

# Package updates and installation
package_update: true
package_upgrade: true
package_reboot_if_required: true

packages:
  # Essential tools
  - curl
  - wget
  - vim
  - git
  - htop
  - net-tools
  # Security
  - fail2ban
  # Puppet dependencies (will be upgraded to Puppet 7 later)
  - ca-certificates

# Write configuration files
write_files:
  # Puppet configuration
  - path: /etc/puppetlabs/puppet/puppet.conf
    content: |
      [main]
      server = pi.ra-home.co.uk
      certname = YOUR_HOSTNAME.ra-home.co.uk
      environment = production
      runinterval = 30m

      [agent]
      report = true
      pluginsync = true
      usecacheonfailure = false
    owner: root:root
    permissions: '0644'

  # Puppet bootstrap script (handles both RedHat and Debian families)
  - path: /tmp/install-puppet.sh
    content: |
      #!/bin/bash
      set -e

      echo "=== Installing Puppet 7 Agent ==="

      if [ -f /etc/redhat-release ]; then
        # RedHat/Rocky/CentOS/Alma
        echo "Detected RedHat-family OS"
        rpm -Uvh https://yum.puppet.com/puppet7-release-el-$(rpm -E %{rhel}).noarch.rpm
        dnf install -y puppet-agent
      elif [ -f /etc/debian_version ]; then
        # Debian/Ubuntu
        echo "Detected Debian-family OS"
        CODENAME=$(lsb_release -sc)
        wget https://apt.puppet.com/puppet7-release-${CODENAME}.deb
        dpkg -i puppet7-release-${CODENAME}.deb
        apt-get update
        apt-get install -y puppet-agent
      else
        echo "ERROR: Unsupported OS"
        exit 1
      fi

      # Add Puppet to PATH for current session
      export PATH="/opt/puppetlabs/bin:$PATH"

      # Add Puppet to PATH permanently
      if ! grep -q '/opt/puppetlabs/bin' /etc/environment; then
        echo 'PATH="/opt/puppetlabs/bin:$PATH"' >> /etc/environment
      fi

      # Create symlinks for common locations
      ln -sf /opt/puppetlabs/bin/puppet /usr/local/bin/puppet
      ln -sf /opt/puppetlabs/bin/facter /usr/local/bin/facter

      echo "=== Puppet agent installed successfully ==="
      /opt/puppetlabs/bin/puppet --version
    owner: root:root
    permissions: '0755'

  # Fail2ban basic configuration
  - path: /etc/fail2ban/jail.local
    content: |
      [DEFAULT]
      bantime = 1h
      findtime = 10m
      maxretry = 5

      [sshd]
      enabled = true
      port = ssh
      logpath = %(sshd_log)s
      backend = %(sshd_backend)s
    owner: root:root
    permissions: '0644'

# Commands to run after system setup
runcmd:
  # Install Puppet agent
  - bash /tmp/install-puppet.sh

  # Start and enable Puppet agent service
  - systemctl enable puppet
  - systemctl start puppet

  # Request Puppet certificate (manual signing required on server)
  - /opt/puppetlabs/bin/puppet agent -t --waitforcert 60 || true

  # Enable and start fail2ban
  - systemctl enable fail2ban
  - systemctl start fail2ban

  # Set timezone (adjust as needed)
  - timedatectl set-timezone UTC

  # Final message
  - echo "Cloud-init bootstrap completed. Puppet agent is requesting certificate."
  - echo "On Puppet server, run: sudo puppetserver ca sign --certname YOUR_HOSTNAME.ra-home.co.uk"

# Final message to display
final_message: |
  ========================================
  Cloud-init bootstrap completed!
  ========================================

  Host: YOUR_HOSTNAME.ra-home.co.uk
  Puppet: Installed and certificate requested

  Next steps:
  1. Sign Puppet certificate on server:
     sudo puppetserver ca sign --certname YOUR_HOSTNAME.ra-home.co.uk

  2. Run Puppet agent:
     sudo puppet agent -t

  3. Verify Puppet facts:
     sudo facter -p

  System is ready for Puppet management.
  ========================================
