---
name: Promote to Production

on:
  push:
    branches:
      - main

jobs:
  create-production-pr:
    name: Create PR to Production
    runs-on: ubuntu-latest
    # Only run if this is a merge (not a direct push)
    if: github.event.head_commit.message != 'Initial commit'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for proper comparison

      - name: Check if production branch exists
        id: check-production
        run: |
          if git ls-remote --heads origin production | grep production; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Create production branch if needed
        if: steps.check-production.outputs.exists == 'false'
        run: |
          git checkout -b production
          git push origin production

      - name: Check for existing PR
        id: check-pr
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_NUMBER=$(gh pr list --base production --head main --state open --json number --jq '.[0].number')
          if [ -n "$PR_NUMBER" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "number=$PR_NUMBER" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Create PR to production
        if: steps.check-pr.outputs.exists == 'false'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Get the commits that will be in the PR
          COMMITS=$(git log origin/production..origin/main --oneline --pretty=format:"- %s" | head -10)

          # Count total commits
          COMMIT_COUNT=$(git rev-list --count origin/production..origin/main)

          # Create PR body
          cat <<EOF > pr_body.md
          ## ðŸš€ Promote main to production

          This PR promotes changes from \`main\` to \`production\` for deployment via r10k.

          ### Changes included ($COMMIT_COUNT commits)
          $COMMITS

          ### Deployment checklist
          - [ ] All CI checks have passed on main
          - [ ] Changes have been tested in a non-production environment
          - [ ] Deployment plan reviewed
          - [ ] Rollback plan prepared

          ---
          ðŸ¤– Auto-generated by GitHub Actions
          EOF

          gh pr create \
            --base production \
            --head main \
            --title "Promote main to production" \
            --body-file pr_body.md

      - name: Update existing PR
        if: steps.check-pr.outputs.exists == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "PR #${{ steps.check-pr.outputs.number }} already exists from main to production"
          gh pr comment ${{ steps.check-pr.outputs.number }} \
            --body "ðŸ”„ New commits pushed to main. This PR has been automatically updated."
