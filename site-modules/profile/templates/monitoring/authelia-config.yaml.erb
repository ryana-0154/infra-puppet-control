# Authelia configuration
# Managed by Puppet - do not edit manually

theme: dark

server:
  host: 0.0.0.0
  port: 9091

log:
  level: info
  format: text

# TOTP (Time-based One-Time Password) configuration
totp:
  disable: false
  issuer: <%= @domain_name || 'authelia.com' %>
  algorithm: sha1
  digits: 6
  period: 30
  skew: 1
  secret_size: 32

# WebAuthn (hardware keys) configuration
webauthn:
  disable: false
  display_name: <%= @domain_name || 'Authelia' %>
  attestation_conveyance_preference: indirect
  user_verification: preferred
  timeout: 60s

# Duo Push 2FA (optional, disabled by default)
duo_api:
  disable: true

# Authentication backend
authentication_backend:
  password_reset:
    disable: false
  refresh_interval: 5m
  file:
    path: /config/users.yaml
    password:
      algorithm: argon2
      argon2:
        variant: argon2id
        iterations: 3
        memory: 65536
        parallelism: 4
        key_length: 32
        salt_length: 16

# Access control rules
access_control:
  default_policy: deny
  rules:
    # Allow access to Authelia portal itself
    - domain:
        - "auth.<%= @domain_name %>"
      policy: bypass

    # Require authentication for all monitoring services
    - domain:
        - "grafana.<%= @domain_name %>"
        - "prometheus.<%= @domain_name %>"
        - "loki.<%= @domain_name %>"
        - "alertmanager.<%= @domain_name %>"
      policy: two_factor

# Session configuration
session:
  name: authelia_session
  domain: <%= @domain_name %>
  same_site: lax
  secret: <%= @authelia_session_secret %>
  expiration: 1h
  inactivity: 5m
  remember_me_duration: 1M

  redis:
    host: redis
    port: 6379
    database_index: 0

# Regulation (brute force protection)
regulation:
  max_retries: 3
  find_time: 2m
  ban_time: 5m

# Storage backend
storage:
  encryption_key: <%= @authelia_storage_encryption_key %>
  local:
    path: /config/db.sqlite3

# Notifier (email notifications - optional)
notifier:
  disable_startup_check: false
  filesystem:
    filename: /config/notification.txt

# Identity providers (OIDC for Grafana)
identity_providers:
  oidc:
    hmac_secret: <%= @authelia_jwt_secret %>
    issuer_private_key: |
<%= @oidc_private_key.gsub(/^/, '      ') if @oidc_private_key -%>
    access_token_lifespan: 1h
    authorize_code_lifespan: 1m
    id_token_lifespan: 1h
    refresh_token_lifespan: 90m
    enable_client_debug_messages: false
    enforce_pkce: public_clients_only

    clients:
<%- if @enable_grafana -%>
      - id: grafana
        description: Grafana
        secret: <%= @grafana_oidc_secret %>
        public: false
        authorization_policy: two_factor
        redirect_uris:
          - https://grafana.<%= @domain_name %>/login/generic_oauth
        scopes:
          - openid
          - profile
          - groups
          - email
        userinfo_signing_algorithm: none
<%- end -%>
