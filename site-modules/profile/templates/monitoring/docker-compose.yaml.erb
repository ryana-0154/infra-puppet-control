x-host: &host
  network_mode: "host"
  restart: unless-stopped

services:
<%- if @enable_grafana_cloud_resolved && @metrics_agent_resolved == 'alloy' -%>
  alloy:
    image: <%= @alloy_image %>
    <<: *host
    container_name: alloy
    command:
      - run
      - --server.http.listen-addr=<%= @monitoring_ip %>:<%= @alloy_http_port %>
      - --storage.path=/var/lib/alloy/data
      - /etc/alloy/config.alloy
    volumes:
      - ./alloy-config.alloy:/etc/alloy/config.alloy:ro
      - /var/log:/var/log:ro
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - /run/log/journal:/run/log/journal:ro
      - /etc/machine-id:/etc/machine-id:ro
      - alloy-data:/var/lib/alloy
<%- end -%>

<%- if @enable_victoriametrics -%>
  victoriametrics:
    image: <%= @victoriametrics_image %>
    <<: *host
    container_name: victoriametrics
    command:
      - -promscrape.config=/etc/victoriametrics/scrape.yaml
      - -httpListenAddr=<%= @monitoring_ip %>:<%= @victoriametrics_port %>
      - -storageDataPath=/victoria-metrics-data
      - -retentionPeriod=12
    volumes:
      - ./victoriametrics-scrape.yaml:/etc/victoriametrics/scrape.yaml:ro
      - victoriametrics-data:/victoria-metrics-data
<%- end -%>

<%- if @enable_grafana -%>
  grafana:
    image: <%= @grafana_image %>
    <<: *host
    container_name: grafana
    environment:
      - GF_SERVER_HTTP_ADDR=<%= @monitoring_ip %>
      - GF_SERVER_HTTP_PORT=<%= @grafana_port %>
      - GF_AUTH_ANONYMOUS_ENABLED=false
<%- if @grafana_admin_password -%>
      - GF_SECURITY_ADMIN_PASSWORD__FILE=/run/secrets/grafana_admin_password
<%- end -%>
<%- unless @grafana_plugins.empty? -%>
      - GF_INSTALL_PLUGINS=<%= @grafana_plugins.join(',') %>
<%- end -%>
<%- if @enable_authelia -%>
      # OIDC SSO with Authelia
      - GF_AUTH_GENERIC_OAUTH_ENABLED=true
      - GF_AUTH_GENERIC_OAUTH_NAME=Authelia
      - GF_AUTH_GENERIC_OAUTH_CLIENT_ID=grafana
      - GF_AUTH_GENERIC_OAUTH_CLIENT_SECRET=<%= @grafana_oidc_secret %>
      - GF_AUTH_GENERIC_OAUTH_SCOPES=openid profile email groups
      - GF_AUTH_GENERIC_OAUTH_AUTH_URL=https://auth.<%= @domain_name %>/api/oidc/authorization
      - GF_AUTH_GENERIC_OAUTH_TOKEN_URL=https://auth.<%= @domain_name %>/api/oidc/token
      - GF_AUTH_GENERIC_OAUTH_API_URL=https://auth.<%= @domain_name %>/api/oidc/userinfo
      - GF_AUTH_GENERIC_OAUTH_LOGIN_ATTRIBUTE_PATH=preferred_username
      - GF_AUTH_GENERIC_OAUTH_GROUPS_ATTRIBUTE_PATH=groups
      - GF_AUTH_GENERIC_OAUTH_NAME_ATTRIBUTE_PATH=name
      - GF_AUTH_GENERIC_OAUTH_USE_PKCE=true
      - GF_AUTH_GENERIC_OAUTH_ROLE_ATTRIBUTE_PATH=contains(groups, 'admins') && 'Admin' || 'Viewer'
      - GF_AUTH_SIGNOUT_REDIRECT_URL=https://auth.<%= @domain_name %>/logout
      - GF_SERVER_ROOT_URL=https://grafana.<%= @domain_name %>
<%- end -%>
<%- if @grafana_admin_password -%>
    secrets:
      - grafana_admin_password
<%- end -%>
    volumes:
      - grafana-data:/var/lib/grafana
      - ./provisioning:/etc/grafana/provisioning:ro
<%- if @enable_external_dashboards -%>
      - ./dashboards-external:/etc/grafana/dashboards-external:ro
<%- end -%>
<%- end -%>

<%- if @enable_loki -%>
  loki:
    image: <%= @loki_image %>
    <<: *host
    container_name: loki
    command: -config.file=/etc/loki/config.yaml
    volumes:
      - ./loki-config.yaml:/etc/loki/config.yaml:ro
      - loki-data:/loki
<%- end -%>

<%- if @enable_promtail -%>
  promtail:
    image: <%= @promtail_image %>
    <<: *host
    container_name: promtail
    command: -config.file=/etc/promtail/config.yaml
    volumes:
      - ./promtail-config.yaml:/etc/promtail/config.yaml:ro
      - /var/log:/var/log:ro
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - /run/log/journal:/run/log/journal:ro
      - /etc/machine-id:/etc/machine-id:ro
<%- end -%>

<%- if @enable_pihole_exporter -%>
  pihole-exporter:
    image: <%= @pihole_exporter_image %>
    <<: *host
    container_name: pihole-exporter
    environment:
      - PIHOLE_HOSTNAME=<%= @pihole_hostname %>
      - PIHOLE_PORT=<%= @pihole_port %>
<%- if @pihole_password -%>
      - PIHOLE_PASSWORD=<%= @pihole_password %>
<%- end -%>
      - INTERVAL=<%= @pihole_interval %>
      - PORT=<%= @pihole_exporter_port %>
<%- end -%>

<%- if @enable_blackbox -%>
  blackbox:
    image: <%= @blackbox_image %>
    <<: *host
    container_name: blackbox-exporter
    command: ["--config.file=/etc/blackbox_exporter/config.yml"]
    volumes:
      - ./blackbox.yaml:/etc/blackbox_exporter/config.yml:ro
<%- end -%>

<%- if @enable_node_exporter -%>
  node_exporter:
    image: <%= @node_exporter_image %>
    container_name: node_exporter
    command:
      - '--path.rootfs=/host'
    network_mode: host
    pid: host
    restart: unless-stopped
    volumes:
      - '/:/host:ro,rslave'
<%- end -%>

<%- if @enable_wireguard_exporter -%>
  wireguard-exporter:
    image: <%= @wireguard_exporter_image %>
    <<: *host
    container_name: wireguard-exporter
    cap_add:
      - NET_ADMIN
    command:
      - --prepend_sudo
      - "false"
    environment:
      - PROMETHEUS_METRICS_ADDR=<%= @monitoring_ip %>:<%= @wireguard_exporter_port %>
    volumes:
      - <%= @wireguard_config_path %>:/etc/wireguard:ro
<%- end -%>

<%- if @enable_unbound_exporter -%>
  unbound-exporter:
    image: <%= @unbound_exporter_image %>
    <<: *host
    container_name: unbound-exporter
    command:
      - -unbound.host
      - unix:///run/unbound.ctl
      - -web.listen-address
      - <%= @monitoring_ip %>:<%= @unbound_exporter_port %>
    volumes:
      - /run/unbound.ctl:/run/unbound.ctl
<%- end -%>

<%- if @enable_unpoller -%>
  unpoller:
    image: <%= @unpoller_image %>
    <<: *host
    container_name: unpoller
    environment:
      - UP_UNIFI_DEFAULT_URL=<%= @unpoller_url %>
      - UP_UNIFI_DEFAULT_USER=<%= @unpoller_user %>
      - UP_UNIFI_DEFAULT_PASS=<%= @unpoller_pass %>
      - UP_UNIFI_DEFAULT_SAVE_DPI=<%= @unpoller_save_dpi %>
      - UP_UNIFI_DEFAULT_VERIFY_SSL=<%= @unpoller_verify_ssl %>
      - UP_PROMETHEUS_HTTP_LISTEN=<%= @monitoring_ip %>:<%= @unpoller_port %>
      - UP_PROMETHEUS_NAMESPACE=unpoller
      - UP_INFLUXDB_DISABLE=true
<%- end -%>

<%- if @enable_wg_portal -%>
  wg-portal:
    image: <%= @wg_portal_image %>
    container_name: wg-portal
    restart: unless-stopped
    logging:
      options:
        max-size: "10m"
        max-file: "3"
    cap_add:
      - NET_ADMIN
    # Use host network mode for WireGuard and the UI. Ensure that access to the UI is properly secured.
    network_mode: "host"
    volumes:
      # left side is the host path, right side is the container path
      - /etc/wireguard:/etc/wireguard
      - ./data:/app/data
      - ./config:/app/config
<%- end -%>

<%- if @enable_redis -%>
  redis:
    image: <%= @redis_image %>
    <<: *host
    container_name: redis
    command: redis-server --save 60 1 --loglevel warning
    volumes:
      - redis-data:/data
<%- end -%>

<%- if @enable_authelia -%>
  authelia:
    image: <%= @authelia_image %>
    <<: *host
    container_name: authelia
    environment:
      - TZ=UTC
    volumes:
      - ./authelia-config.yaml:/config/configuration.yml:ro
      - ./authelia-users.yaml:/config/users.yaml:ro
      - authelia-data:/config
    depends_on:
<%- if @enable_redis -%>
      - redis
<%- end -%>
<%- end -%>

<%- if @enable_nginx_proxy -%>
  nginx:
    image: <%= @nginx_image %>
    container_name: nginx-proxy
    network_mode: "host"
    restart: unless-stopped
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - nginx-logs:/var/log/nginx
<%- if @enable_ssl -%>
      - letsencrypt:/etc/letsencrypt:ro
      - letsencrypt-www:/var/www/certbot:ro
<%- end -%>
    depends_on:
<%- if @enable_authelia -%>
      - authelia
<%- end -%>
<%- if @enable_grafana -%>
      - grafana
<%- end -%>
<%- if @enable_victoriametrics -%>
      - victoriametrics
<%- end -%>
<%- if @enable_loki -%>
      - loki
<%- end -%>

<%- if @enable_ssl -%>
  certbot:
    image: <%= @certbot_image %>
    container_name: certbot
    volumes:
      - letsencrypt:/etc/letsencrypt
      - letsencrypt-www:/var/www/certbot
    entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew; sleep 12h & wait $${!}; done;'"
<%- end -%>
<%- end -%>

volumes:
<%- if @enable_grafana_cloud_resolved && @metrics_agent_resolved == 'alloy' -%>
  alloy-data:
<%- end -%>
<%- if @enable_grafana -%>
  grafana-data:
<%- end -%>
<%- if @enable_victoriametrics -%>
  victoriametrics-data:
<%- end -%>
<%- if @enable_loki -%>
  loki-data:
<%- end -%>
<%- if @enable_redis -%>
  redis-data:
<%- end -%>
<%- if @enable_authelia -%>
  authelia-data:
<%- end -%>
<%- if @enable_nginx_proxy -%>
  nginx-logs:
<%- end -%>
<%- if @enable_ssl -%>
  letsencrypt:
  letsencrypt-www:
<%- end -%>

<%- if @grafana_admin_password -%>
secrets:
  grafana_admin_password:
    file: ./secrets/grafana_admin_password
<%- end -%>
