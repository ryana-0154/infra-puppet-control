# Promtail configuration
# Managed by Puppet - do not edit manually

server:
  http_listen_port: 9080
  grpc_listen_port: 0

positions:
  filename: /tmp/positions.yaml

clients:
<%- if @enable_loki -%>
  - url: http://<%= @monitoring_ip %>:3100/loki/api/v1/push
<%- else -%>
  # Loki disabled - configure external Loki endpoint
  # - url: http://external-loki:3100/loki/api/v1/push
<%- end -%>

scrape_configs:
# System logs
- job_name: system
  static_configs:
  - targets:
      - localhost
    labels:
      job: varlogs
      host: <%= @facts['networking']['fqdn'] || @facts['networking']['hostname'] || 'unknown' %>
      __path__: /var/log/*log

# Syslog
- job_name: syslog
  static_configs:
  - targets:
      - localhost
    labels:
      job: syslog
      host: <%= @facts['networking']['fqdn'] || @facts['networking']['hostname'] || 'unknown' %>
      __path__: /var/log/syslog

# Authentication logs (Debian/Ubuntu)
- job_name: auth
  static_configs:
  - targets:
      - localhost
    labels:
      job: auth
      host: <%= @facts['networking']['fqdn'] || @facts['networking']['hostname'] || 'unknown' %>
      log_type: authentication
      __path__: /var/log/auth.log

# Secure logs (RedHat/Rocky/AlmaLinux)
- job_name: secure
  static_configs:
  - targets:
      - localhost
    labels:
      job: secure
      host: <%= @facts['networking']['fqdn'] || @facts['networking']['hostname'] || 'unknown' %>
      log_type: authentication
      __path__: /var/log/secure

# Fail2ban logs
- job_name: fail2ban
  static_configs:
  - targets:
      - localhost
    labels:
      job: fail2ban
      host: <%= @facts['networking']['fqdn'] || @facts['networking']['hostname'] || 'unknown' %>
      log_type: security
      __path__: /var/log/fail2ban.log
  pipeline_stages:
    - regex:
        expression: '(?P<timestamp>\S+ \S+) (?P<jail>\S+)\s+\[(?P<pid>\d+)\]: (?P<level>\S+)\s+(?P<message>.*)'
    - labels:
        jail:
        level:

# Puppet logs
- job_name: puppet
  static_configs:
  - targets:
      - localhost
    labels:
      job: puppet
      host: <%= @facts['networking']['fqdn'] || @facts['networking']['hostname'] || 'unknown' %>
      log_type: configuration_management
      __path__: /var/log/puppetlabs/puppet/*.log

# Nginx access logs
- job_name: nginx_access
  static_configs:
  - targets:
      - localhost
    labels:
      job: nginx
      log_type: access
      host: <%= @facts['networking']['fqdn'] || @facts['networking']['hostname'] || 'unknown' %>
      __path__: /var/log/nginx/*access.log
  pipeline_stages:
    - regex:
        expression: '^(?P<remote_addr>\S+) - (?P<remote_user>[^ ]*) \[(?P<time_local>.*)\] "(?P<method>[^ ]*) (?P<path>[^ ]*) (?P<protocol>[^ ]*)" (?P<status>[\d]+) (?P<body_bytes_sent>[\d]+) "(?P<http_referer>[^"]*)" "(?P<http_user_agent>[^"]*)"'
    - labels:
        method:
        status:

# Nginx error logs
- job_name: nginx_error
  static_configs:
  - targets:
      - localhost
    labels:
      job: nginx
      log_type: error
      host: <%= @facts['networking']['fqdn'] || @facts['networking']['hostname'] || 'unknown' %>
      __path__: /var/log/nginx/*error.log
  pipeline_stages:
    - regex:
        expression: '^(?P<timestamp>\S+ \S+) \[(?P<level>\w+)\] (?P<message>.*)'
    - labels:
        level:

# Apache access logs
- job_name: apache_access
  static_configs:
  - targets:
      - localhost
    labels:
      job: apache
      log_type: access
      host: <%= @facts['networking']['fqdn'] || @facts['networking']['hostname'] || 'unknown' %>
      __path__: /var/log/apache2/*access*.log

# Apache error logs
- job_name: apache_error
  static_configs:
  - targets:
      - localhost
    labels:
      job: apache
      log_type: error
      host: <%= @facts['networking']['fqdn'] || @facts['networking']['hostname'] || 'unknown' %>
      __path__: /var/log/apache2/*error*.log

# Docker container logs (general)
- job_name: docker
  static_configs:
  - targets:
      - localhost
    labels:
      job: docker
      host: <%= @facts['networking']['fqdn'] || @facts['networking']['hostname'] || 'unknown' %>
      __path__: /var/lib/docker/containers/*/*log
  pipeline_stages:
    - json:
        expressions:
          output: log
          stream: stream
          time: time
    - labels:
        stream:
    - output:
        source: output

# Monitoring stack container logs (labeled specifically)
<%- if @enable_prometheus -%>
- job_name: prometheus-container
  docker_sd_configs:
    - host: unix:///var/run/docker.sock
      refresh_interval: 5s
  relabel_configs:
    - source_labels: ['__meta_docker_container_name']
      regex: '/prometheus'
      action: keep
    - source_labels: ['__meta_docker_container_name']
      target_label: container_name
    - source_labels: ['__meta_docker_container_log_stream']
      target_label: stream
  static_configs:
  - labels:
      job: prometheus
      host: <%= @facts['networking']['fqdn'] || @facts['networking']['hostname'] || 'unknown' %>
      log_type: monitoring
<%- end -%>

<%- if @enable_grafana -%>
- job_name: grafana-container
  docker_sd_configs:
    - host: unix:///var/run/docker.sock
      refresh_interval: 5s
  relabel_configs:
    - source_labels: ['__meta_docker_container_name']
      regex: '/grafana'
      action: keep
    - source_labels: ['__meta_docker_container_name']
      target_label: container_name
    - source_labels: ['__meta_docker_container_log_stream']
      target_label: stream
  static_configs:
  - labels:
      job: grafana
      host: <%= @facts['networking']['fqdn'] || @facts['networking']['hostname'] || 'unknown' %>
      log_type: monitoring
<%- end -%>

<%- if @enable_loki -%>
- job_name: loki-container
  docker_sd_configs:
    - host: unix:///var/run/docker.sock
      refresh_interval: 5s
  relabel_configs:
    - source_labels: ['__meta_docker_container_name']
      regex: '/loki'
      action: keep
    - source_labels: ['__meta_docker_container_name']
      target_label: container_name
    - source_labels: ['__meta_docker_container_log_stream']
      target_label: stream
  static_configs:
  - labels:
      job: loki
      host: <%= @facts['networking']['fqdn'] || @facts['networking']['hostname'] || 'unknown' %>
      log_type: monitoring
<%- end -%>

<%- if @enable_promtail -%>
- job_name: promtail-container
  docker_sd_configs:
    - host: unix:///var/run/docker.sock
      refresh_interval: 5s
  relabel_configs:
    - source_labels: ['__meta_docker_container_name']
      regex: '/promtail'
      action: keep
    - source_labels: ['__meta_docker_container_name']
      target_label: container_name
    - source_labels: ['__meta_docker_container_log_stream']
      target_label: stream
  static_configs:
  - labels:
      job: promtail
      host: <%= @facts['networking']['fqdn'] || @facts['networking']['hostname'] || 'unknown' %>
      log_type: monitoring
<%- end -%>

<%- if @enable_blackbox -%>
- job_name: blackbox-container
  docker_sd_configs:
    - host: unix:///var/run/docker.sock
      refresh_interval: 5s
  relabel_configs:
    - source_labels: ['__meta_docker_container_name']
      regex: '/blackbox-exporter'
      action: keep
    - source_labels: ['__meta_docker_container_name']
      target_label: container_name
    - source_labels: ['__meta_docker_container_log_stream']
      target_label: stream
  static_configs:
  - labels:
      job: blackbox-exporter
      host: <%= @facts['networking']['fqdn'] || @facts['networking']['hostname'] || 'unknown' %>
      log_type: monitoring
<%- end -%>

<%- if @enable_node_exporter -%>
- job_name: node-exporter-container
  docker_sd_configs:
    - host: unix:///var/run/docker.sock
      refresh_interval: 5s
  relabel_configs:
    - source_labels: ['__meta_docker_container_name']
      regex: '/node_exporter'
      action: keep
    - source_labels: ['__meta_docker_container_name']
      target_label: container_name
    - source_labels: ['__meta_docker_container_log_stream']
      target_label: stream
  static_configs:
  - labels:
      job: node-exporter
      host: <%= @facts['networking']['fqdn'] || @facts['networking']['hostname'] || 'unknown' %>
      log_type: monitoring
<%- end -%>

<%- if @enable_pihole_exporter -%>
- job_name: pihole-exporter-container
  docker_sd_configs:
    - host: unix:///var/run/docker.sock
      refresh_interval: 5s
  relabel_configs:
    - source_labels: ['__meta_docker_container_name']
      regex: '/pihole-exporter'
      action: keep
    - source_labels: ['__meta_docker_container_name']
      target_label: container_name
    - source_labels: ['__meta_docker_container_log_stream']
      target_label: stream
  static_configs:
  - labels:
      job: pihole-exporter
      host: <%= @facts['networking']['fqdn'] || @facts['networking']['hostname'] || 'unknown' %>
      log_type: monitoring
<%- end -%>

<%- if @enable_nginx_proxy -%>
- job_name: nginx-proxy-container
  docker_sd_configs:
    - host: unix:///var/run/docker.sock
      refresh_interval: 5s
  relabel_configs:
    - source_labels: ['__meta_docker_container_name']
      regex: '/nginx-proxy'
      action: keep
    - source_labels: ['__meta_docker_container_name']
      target_label: container_name
    - source_labels: ['__meta_docker_container_log_stream']
      target_label: stream
  static_configs:
  - labels:
      job: nginx-proxy
      host: <%= @facts['networking']['fqdn'] || @facts['networking']['hostname'] || 'unknown' %>
      log_type: monitoring
<%- end -%>

<%- if @enable_authelia -%>
- job_name: authelia-container
  docker_sd_configs:
    - host: unix:///var/run/docker.sock
      refresh_interval: 5s
  relabel_configs:
    - source_labels: ['__meta_docker_container_name']
      regex: '/authelia'
      action: keep
    - source_labels: ['__meta_docker_container_name']
      target_label: container_name
    - source_labels: ['__meta_docker_container_log_stream']
      target_label: stream
  static_configs:
  - labels:
      job: authelia
      host: <%= @facts['networking']['fqdn'] || @facts['networking']['hostname'] || 'unknown' %>
      log_type: monitoring
<%- end -%>

<%- if @enable_redis -%>
- job_name: redis-container
  docker_sd_configs:
    - host: unix:///var/run/docker.sock
      refresh_interval: 5s
  relabel_configs:
    - source_labels: ['__meta_docker_container_name']
      regex: '/redis'
      action: keep
    - source_labels: ['__meta_docker_container_name']
      target_label: container_name
    - source_labels: ['__meta_docker_container_log_stream']
      target_label: stream
  static_configs:
  - labels:
      job: redis
      host: <%= @facts['networking']['fqdn'] || @facts['networking']['hostname'] || 'unknown' %>
      log_type: monitoring
<%- end -%>

# Systemd journal logs
- job_name: systemd-journal
  journal:
    max_age: 12h
    labels:
      job: systemd-journal
      host: <%= @facts['networking']['fqdn'] || @facts['networking']['hostname'] || 'unknown' %>
  relabel_configs:
    - source_labels: ['__journal__systemd_unit']
      target_label: 'unit'
    - source_labels: ['__journal_priority']
      target_label: 'priority'
    - source_labels: ['__journal__hostname']
      target_label: 'nodename'

# Unbound DNS resolver logs
- job_name: unbound
  static_configs:
  - targets:
      - localhost
    labels:
      job: unbound
      host: <%= @facts['networking']['fqdn'] || @facts['networking']['hostname'] || 'unknown' %>
      log_type: dns
      __path__: /var/log/unbound/unbound.log
  pipeline_stages:
    - regex:
        expression: '^\[(?P<timestamp>.*?)\] unbound\[(?P<pid>\d+):(?P<thread>\d+)\] (?P<level>\w+): (?P<message>.*)'
    - labels:
        level:

# Pi-hole logs
- job_name: pihole
  static_configs:
  - targets:
      - localhost
    labels:
      job: pihole
      host: <%= @facts['networking']['fqdn'] || @facts['networking']['hostname'] || 'unknown' %>
      log_type: dns
      __path__: /var/log/pihole/pihole.log

# Pi-hole FTL logs
- job_name: pihole-ftl
  static_configs:
  - targets:
      - localhost
    labels:
      job: pihole-ftl
      host: <%= @facts['networking']['fqdn'] || @facts['networking']['hostname'] || 'unknown' %>
      log_type: dns
      __path__: /var/log/pihole/FTL.log

# Kernel logs
- job_name: kernel
  static_configs:
  - targets:
      - localhost
    labels:
      job: kernel
      host: <%= @facts['networking']['fqdn'] || @facts['networking']['hostname'] || 'unknown' %>
      log_type: system
      __path__: /var/log/kern.log

# Cron logs
- job_name: cron
  static_configs:
  - targets:
      - localhost
    labels:
      job: cron
      host: <%= @facts['networking']['fqdn'] || @facts['networking']['hostname'] || 'unknown' %>
      log_type: system
      __path__: /var/log/cron.log

# APT/package management logs
- job_name: apt
  static_configs:
  - targets:
      - localhost
    labels:
      job: apt
      host: <%= @facts['networking']['fqdn'] || @facts['networking']['hostname'] || 'unknown' %>
      log_type: package_management
      __path__: /var/log/apt/*.log

# Unattended upgrades logs
- job_name: unattended-upgrades
  static_configs:
  - targets:
      - localhost
    labels:
      job: unattended-upgrades
      host: <%= @facts['networking']['fqdn'] || @facts['networking']['hostname'] || 'unknown' %>
      log_type: package_management
      __path__: /var/log/unattended-upgrades/unattended-upgrades.log
