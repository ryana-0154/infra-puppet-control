# Promtail configuration
# Managed by Puppet - do not edit manually

server:
  http_listen_port: 9080
  grpc_listen_port: 0

positions:
  filename: /tmp/positions.yaml

clients:
<%- if @promtail_enable_grafana_cloud -%>
  - url: <%= @promtail_grafana_cloud_logs_url %>
    basic_auth:
      username: <%= @promtail_grafana_cloud_logs_username %>
      password: <%= @promtail_grafana_cloud_logs_api_key.unwrap %>
<%- elsif @promtail_enable_loki -%>
  - url: http://<%= @promtail_monitoring_ip %>:3100/loki/api/v1/push
<%- else -%>
  # Loki disabled - configure external Loki endpoint
  # - url: http://external-loki:3100/loki/api/v1/push
<%- end -%>

scrape_configs:
# System logs
- job_name: system
  static_configs:
  - targets:
      - localhost
    labels:
      job: varlogs
      host: <%= @promtail_facts['networking']['fqdn'] || @promtail_facts['networking']['hostname'] || 'unknown' %>
      __path__: /var/log/*log
  pipeline_stages:
    - regex:
        expression: '^(?P<ts>\w{3}\s+\d+\s+\d{2}:\d{2}:\d{2}) (?P<host>\S+) (?P<program>\S+?)(?:\[(?P<pid>\d+)\])?: (?P<msg>.*)$'
    - timestamp:
        source: ts
        format: 'Jan _2 15:04:05'
        # timezone: UTC   # or your actual TZ if needed
    - labels:
        host:
        program:
    - output:
        source: msg

# Syslog
- job_name: syslog
  static_configs:
  - targets:
      - localhost
    labels:
      job: syslog
      host: <%= @promtail_facts['networking']['fqdn'] || @promtail_facts['networking']['hostname'] || 'unknown' %>
      __path__: /var/log/syslog
  pipeline_stages:
    - regex:
        expression: '^(?P<ts>\w{3}\s+\d+\s+\d{2}:\d{2}:\d{2}) (?P<host>\S+) (?P<program>\S+?)(?:\[(?P<pid>\d+)\])?: (?P<msg>.*)$'
    - timestamp:
        source: ts
        format: 'Jan _2 15:04:05'
        # timezone: UTC   # or your actual TZ if needed
    - labels:
        host:
        program:
    - output:
        source: msg

# Authentication logs (Debian/Ubuntu)
- job_name: auth
  static_configs:
  - targets:
      - localhost
    labels:
      job: auth
      host: <%= @promtail_facts['networking']['fqdn'] || @promtail_facts['networking']['hostname'] || 'unknown' %>
      log_type: authentication
      __path__: /var/log/auth.log
  pipeline_stages:
    - regex:
        expression: '^(?P<ts>\w{3}\s+\d+\s+\d{2}:\d{2}:\d{2}) (?P<host>\S+) (?P<program>\S+?)(?:\[(?P<pid>\d+)\])?: (?P<msg>.*)$'
    - timestamp:
        source: ts
        format: 'Jan _2 15:04:05'
        # timezone: UTC   # or your actual TZ if needed
    - labels:
        host:
        program:
    - output:
        source: msg

# Secure logs (RedHat/Rocky/AlmaLinux)
- job_name: secure
  static_configs:
  - targets:
      - localhost
    labels:
      job: secure
      host: <%= @promtail_facts['networking']['fqdn'] || @promtail_facts['networking']['hostname'] || 'unknown' %>
      log_type: authentication
      __path__: /var/log/secure
  pipeline_stages:
    - regex:
        expression: '^(?P<ts>\w{3}\s+\d+\s+\d{2}:\d{2}:\d{2}) (?P<host>\S+) (?P<program>\S+?)(?:\[(?P<pid>\d+)\])?: (?P<msg>.*)$'
    - timestamp:
        source: ts
        format: 'Jan _2 15:04:05'
        # timezone: UTC   # or your actual TZ if needed
    - labels:
        host:
        program:
    - output:
        source: msg

# Fail2ban logs
- job_name: fail2ban
  static_configs:
  - targets:
      - localhost
    labels:
      job: fail2ban
      host: <%= @promtail_facts['networking']['fqdn'] || @promtail_facts['networking']['hostname'] || 'unknown' %>
      log_type: security
      __path__: /var/log/fail2ban.log
  pipeline_stages:
  - regex:
      expression: '^(?P<ts>\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2},\d+)\s+(?P<logger>\S+)\s+\[(?P<pid>\d+)\]:\s+(?P<level>\w+)\s+\[(?P<jail>\w+)\]\s+(?P<action>\w+)\s+(?P<ip>\S+).*'
  - timestamp:
      source: ts
      format: '2006-01-02 15:04:05,000'
  - labels:
      jail:
      level:
      action:
  - output:
      source: ""


# Puppet logs
- job_name: puppet
  static_configs:
  - targets:
      - localhost
    labels:
      job: puppet
      host: <%= @promtail_facts['networking']['fqdn'] || @promtail_facts['networking']['hostname'] || 'unknown' %>
      log_type: configuration_management
      __path__: /var/log/puppetlabs/puppet/*.log
  pipeline_stages:
    - regex:
        expression: '^(?P<ts>\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}\.\d+Z)\s+(?P<level>\w+)\s+\[(?P<component>[^\]]+)\]\s+(?P<msg>.*)$'
    - timestamp:
        source: ts
        format: '2006-01-02T15:04:05.000Z'
    - labels:
        level:
        component:
    - output:
        source: msg

# Nginx access logs
- job_name: nginx_access
  static_configs:
  - targets:
      - localhost
    labels:
      job: nginx
      log_type: access
      host: <%= @promtail_facts['networking']['fqdn'] || @promtail_facts['networking']['hostname'] || 'unknown' %>
      __path__: /var/log/nginx/*access.log
  pipeline_stages:
    - regex:
        expression: '^(?P<remote_addr>\S+) \S+ \S+ \[(?P<ts>[^\]]+)\] "(?P<method>\S+) (?P<path>[^"]*?) (?P<protocol>[^"]*?)" (?P<status>\d{3}) (?P<body_bytes_sent>\d+|-) "(?P<referrer>[^"]*)" "(?P<user_agent>[^"]*)"'
    - timestamp:
        source: ts
        format: '02/Jan/2006:15:04:05 -0700'
    - labels:
        status:
        method:
    - output:
        source: path

# Nginx error logs
- job_name: nginx_error
  static_configs:
  - targets:
      - localhost
    labels:
      job: nginx
      log_type: error
      host: <%= @promtail_facts['networking']['fqdn'] || @promtail_facts['networking']['hostname'] || 'unknown' %>
      __path__: /var/log/nginx/*error.log
  pipeline_stages:
    - regex:
        expression: '^(?P<remote_addr>\S+) \S+ \S+ \[(?P<ts>[^\]]+)\] "(?P<method>\S+) (?P<path>[^"]*?) (?P<protocol>[^"]*?)" (?P<status>\d{3}) (?P<body_bytes_sent>\d+|-) "(?P<referrer>[^"]*)" "(?P<user_agent>[^"]*)"'
    - timestamp:
        source: ts
        format: '02/Jan/2006:15:04:05 -0700'
    - labels:
        status:
        method:
    - output:
        source: path

# Apache access logs
- job_name: apache_access
  static_configs:
  - targets:
      - localhost
    labels:
      job: apache
      log_type: access
      host: <%= @promtail_facts['networking']['fqdn'] || @promtail_facts['networking']['hostname'] || 'unknown' %>
      __path__: /var/log/apache2/*access*.log

# Apache error logs
- job_name: apache_error
  static_configs:
  - targets:
      - localhost
    labels:
      job: apache
      log_type: error
      host: <%= @promtail_facts['networking']['fqdn'] || @promtail_facts['networking']['hostname'] || 'unknown' %>
      __path__: /var/log/apache2/*error*.log

# Docker container logs (general)
- job_name: docker
  static_configs:
  - targets:
      - localhost
    labels:
      job: docker
      host: <%= @promtail_facts['networking']['fqdn'] || @promtail_facts['networking']['hostname'] || 'unknown' %>
      __path__: /var/lib/docker/containers/*/*log
  pipeline_stages:
    - cri: {}
    # If your app logs JSON inside "log", then:
    - json:
        expressions:
          level: level
          msg: msg
    - labels:
        level:
    - output:
        source: msg


# Monitoring stack container logs (labeled specifically)
<%- if @promtail_enable_prometheus -%>
- job_name: prometheus-container
  docker_sd_configs:
    - host: unix:///var/run/docker.sock
      refresh_interval: 5s
  relabel_configs:
    - source_labels: ['__meta_docker_container_name']
      regex: '/prometheus'
      action: keep
    - source_labels: ['__meta_docker_container_name']
      target_label: container_name
    - source_labels: ['__meta_docker_container_log_stream']
      target_label: stream
  static_configs:
  - labels:
      job: prometheus
      host: <%= @promtail_facts['networking']['fqdn'] || @promtail_facts['networking']['hostname'] || 'unknown' %>
      log_type: monitoring
<%- end -%>

<%- if @promtail_enable_grafana -%>
- job_name: grafana-container
  docker_sd_configs:
    - host: unix:///var/run/docker.sock
      refresh_interval: 5s
  relabel_configs:
    - source_labels: ['__meta_docker_container_name']
      regex: '/grafana'
      action: keep
    - source_labels: ['__meta_docker_container_name']
      target_label: container_name
    - source_labels: ['__meta_docker_container_log_stream']
      target_label: stream
  static_configs:
  - labels:
      job: grafana
      host: <%= @promtail_facts['networking']['fqdn'] || @promtail_facts['networking']['hostname'] || 'unknown' %>
      log_type: monitoring
<%- end -%>

<%- if @promtail_enable_loki -%>
- job_name: loki-container
  docker_sd_configs:
    - host: unix:///var/run/docker.sock
      refresh_interval: 5s
  relabel_configs:
    - source_labels: ['__meta_docker_container_name']
      regex: '/loki'
      action: keep
    - source_labels: ['__meta_docker_container_name']
      target_label: container_name
    - source_labels: ['__meta_docker_container_log_stream']
      target_label: stream
  static_configs:
  - labels:
      job: loki
      host: <%= @promtail_facts['networking']['fqdn'] || @promtail_facts['networking']['hostname'] || 'unknown' %>
      log_type: monitoring
<%- end -%>

<%- if @promtail_enable_promtail -%>
- job_name: promtail-container
  docker_sd_configs:
    - host: unix:///var/run/docker.sock
      refresh_interval: 5s
  relabel_configs:
    - source_labels: ['__meta_docker_container_name']
      regex: '/promtail'
      action: keep
    - source_labels: ['__meta_docker_container_name']
      target_label: container_name
    - source_labels: ['__meta_docker_container_log_stream']
      target_label: stream
  static_configs:
  - labels:
      job: promtail
      host: <%= @promtail_facts['networking']['fqdn'] || @promtail_facts['networking']['hostname'] || 'unknown' %>
      log_type: monitoring
<%- end -%>

<%- if @promtail_enable_blackbox -%>
- job_name: blackbox-container
  docker_sd_configs:
    - host: unix:///var/run/docker.sock
      refresh_interval: 5s
  relabel_configs:
    - source_labels: ['__meta_docker_container_name']
      regex: '/blackbox-exporter'
      action: keep
    - source_labels: ['__meta_docker_container_name']
      target_label: container_name
    - source_labels: ['__meta_docker_container_log_stream']
      target_label: stream
  static_configs:
  - labels:
      job: blackbox-exporter
      host: <%= @promtail_facts['networking']['fqdn'] || @promtail_facts['networking']['hostname'] || 'unknown' %>
      log_type: monitoring
<%- end -%>

<%- if @promtail_enable_node_exporter -%>
- job_name: node-exporter-container
  docker_sd_configs:
    - host: unix:///var/run/docker.sock
      refresh_interval: 5s
  relabel_configs:
    - source_labels: ['__meta_docker_container_name']
      regex: '/node_exporter'
      action: keep
    - source_labels: ['__meta_docker_container_name']
      target_label: container_name
    - source_labels: ['__meta_docker_container_log_stream']
      target_label: stream
  static_configs:
  - labels:
      job: node-exporter
      host: <%= @promtail_facts['networking']['fqdn'] || @promtail_facts['networking']['hostname'] || 'unknown' %>
      log_type: monitoring
<%- end -%>

<%- if @promtail_enable_pihole_exporter -%>
- job_name: pihole-exporter-container
  docker_sd_configs:
    - host: unix:///var/run/docker.sock
      refresh_interval: 5s
  relabel_configs:
    - source_labels: ['__meta_docker_container_name']
      regex: '/pihole-exporter'
      action: keep
    - source_labels: ['__meta_docker_container_name']
      target_label: container_name
    - source_labels: ['__meta_docker_container_log_stream']
      target_label: stream
  static_configs:
  - labels:
      job: pihole-exporter
      host: <%= @promtail_facts['networking']['fqdn'] || @promtail_facts['networking']['hostname'] || 'unknown' %>
      log_type: monitoring
<%- end -%>

<%- if @promtail_enable_nginx_proxy -%>
- job_name: nginx-proxy-container
  docker_sd_configs:
    - host: unix:///var/run/docker.sock
      refresh_interval: 5s
  relabel_configs:
    - source_labels: ['__meta_docker_container_name']
      regex: '/nginx-proxy'
      action: keep
    - source_labels: ['__meta_docker_container_name']
      target_label: container_name
    - source_labels: ['__meta_docker_container_log_stream']
      target_label: stream
  static_configs:
  - labels:
      job: nginx-proxy
      host: <%= @promtail_facts['networking']['fqdn'] || @promtail_facts['networking']['hostname'] || 'unknown' %>
      log_type: monitoring
<%- end -%>

<%- if @promtail_enable_authelia -%>
- job_name: authelia-container
  docker_sd_configs:
    - host: unix:///var/run/docker.sock
      refresh_interval: 5s
  relabel_configs:
    - source_labels: ['__meta_docker_container_name']
      regex: '/authelia'
      action: keep
    - source_labels: ['__meta_docker_container_name']
      target_label: container_name
    - source_labels: ['__meta_docker_container_log_stream']
      target_label: stream
  static_configs:
  - labels:
      job: authelia
      host: <%= @promtail_facts['networking']['fqdn'] || @promtail_facts['networking']['hostname'] || 'unknown' %>
      log_type: monitoring
<%- end -%>

<%- if @promtail_enable_redis -%>
- job_name: redis-container
  docker_sd_configs:
    - host: unix:///var/run/docker.sock
      refresh_interval: 5s
  relabel_configs:
    - source_labels: ['__meta_docker_container_name']
      regex: '/redis'
      action: keep
    - source_labels: ['__meta_docker_container_name']
      target_label: container_name
    - source_labels: ['__meta_docker_container_log_stream']
      target_label: stream
  static_configs:
  - labels:
      job: redis
      host: <%= @promtail_facts['networking']['fqdn'] || @promtail_facts['networking']['hostname'] || 'unknown' %>
      log_type: monitoring
<%- end -%>

# Systemd journal logs
- job_name: systemd-journal
  journal:
    max_age: 12h
    labels:
      job: systemd-journal
      host: <%= @promtail_facts['networking']['fqdn'] || @promtail_facts['networking']['hostname'] || 'unknown' %>
  relabel_configs:
    - source_labels: ['__journal__systemd_unit']
      target_label: 'unit'
    - source_labels: ['__journal_priority']
      target_label: 'priority'
    - source_labels: ['__journal__hostname']
      target_label: 'nodename'

# Unbound DNS resolver logs
- job_name: unbound
  static_configs:
  - targets:
      - localhost
    labels:
      job: unbound
      host: <%= @promtail_facts['networking']['fqdn'] || @promtail_facts['networking']['hostname'] || 'unknown' %>
      log_type: dns
      __path__: /var/log/unbound/unbound.log
  pipeline_stages:
    - match:
        selector: '{job="unbound"} |~ " start | stopped |.*in-addr.arpa."'
        action: drop
    - match:
        selector: '{job="unbound"} |= "reply:"'
        stages:
        - static_labels:
            dns: reply
    - match:
        selector: '{job="unbound"} |~ "always_null|redirect |always_nxdomain"'
        stages:
        - static_labels:
            dns: block

# Pi-hole logs
- job_name: pihole
  static_configs:
  - targets:
      - localhost
    labels:
      job: pihole
      host: <%= @promtail_facts['networking']['fqdn'] || @promtail_facts['networking']['hostname'] || 'unknown' %>
      log_type: dns
      __path__: /var/log/pihole/pihole.log
  pipeline_stages:
    - regex:
        expression: '^(?P<ts>\w{3}\s+\d+\s+\d{2}:\d{2}:\d{2}) (?P<daemon>\S+)\[(?P<pid>\d+)\]: (?P<msg>.*)$'
    - timestamp:
        source: ts
        format: 'Jan _2 15:04:05'
    - labels:
        daemon:
    - output:
        source: msg


# Pi-hole FTL logs
- job_name: pihole-ftl
  static_configs:
  - targets:
      - localhost
    labels:
      job: pihole-ftl
      host: <%= @promtail_facts['networking']['fqdn'] || @promtail_facts['networking']['hostname'] || 'unknown' %>
      log_type: dns
      __path__: /var/log/pihole/FTL.log
  pipeline_stages:
    - regex:
        expression: '^(?P<ts>\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}\.\d+)\s+(?P<level>\w+)\s+(?P<msg>.*)$'
    - timestamp:
        source: ts
        format: '2006-01-02 15:04:05.000000'
    - labels:
        level:
    - output:
        source: msg


# Kernel logs
- job_name: kernel
  static_configs:
  - targets:
      - localhost
    labels:
      job: kernel
      host: <%= @promtail_facts['networking']['fqdn'] || @promtail_facts['networking']['hostname'] || 'unknown' %>
      log_type: system
      __path__: /var/log/kern.log
  pipeline_stages:
    - regex:
        expression: '^(?P<ts>\w{3}\s+\d+\s+\d{2}:\d{2}:\d{2}) (?P<host>\S+) (?P<program>\S+?)(?:\[(?P<pid>\d+)\])?: (?P<msg>.*)$'
    - timestamp:
        source: ts
        format: 'Jan _2 15:04:05'
        # timezone: UTC   # or your actual TZ if needed
    - labels:
        host:
        program:
    - output:
        source: msg

# Cron logs
- job_name: cron
  static_configs:
  - targets:
      - localhost
    labels:
      job: cron
      host: <%= @promtail_facts['networking']['fqdn'] || @promtail_facts['networking']['hostname'] || 'unknown' %>
      log_type: system
      __path__: /var/log/cron.log
  pipeline_stages:
    - regex:
        expression: '^(?P<ts>\w{3}\s+\d+\s+\d{2}:\d{2}:\d{2}) (?P<host>\S+) (?P<program>\S+?)(?:\[(?P<pid>\d+)\])?: (?P<msg>.*)$'
    - timestamp:
        source: ts
        format: 'Jan _2 15:04:05'
        # timezone: UTC   # or your actual TZ if needed
    - labels:
        host:
        program:
    - output:
        source: msg

# APT/package management logs
- job_name: apt
  static_configs:
  - targets:
      - localhost
    labels:
      job: apt
      host: <%= @promtail_facts['networking']['fqdn'] || @promtail_facts['networking']['hostname'] || 'unknown' %>
      log_type: package_management
      __path__: /var/log/apt/*.log
  pipeline_stages:
  - regex:
      expression: '^(?P<ts>\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}) (?P<action>\S+) (?P<msg>.*)$'
  - timestamp:
      source: ts
      format: '2006-01-02 15:04:05'
  - labels:
      action:
  - output:
      source: msg


# Unattended upgrades logs
- job_name: unattended-upgrades
  static_configs:
  - targets:
      - localhost
    labels:
      job: unattended-upgrades
      host: <%= @promtail_facts['networking']['fqdn'] || @promtail_facts['networking']['hostname'] || 'unknown' %>
      log_type: package_management
      __path__: /var/log/unattended-upgrades/unattended-upgrades.log
  pipeline_stages:
  - regex:
      expression: '^(?P<ts>\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}) (?P<action>\S+) (?P<msg>.*)$'
  - timestamp:
      source: ts
      format: '2006-01-02 15:04:05'
  - labels:
      action:
  - output:
      source: msg


# WireGuard VPN logs (via systemd journal)
- job_name: wireguard
  journal:
    max_age: 12h
    labels:
      job: wireguard
      host: <%= @promtail_facts['networking']['fqdn'] || @promtail_facts['networking']['hostname'] || 'unknown' %>
      log_type: vpn
  relabel_configs:
    - source_labels: ['__journal__systemd_unit']
      regex: 'wg-quick@.*\.service'
      action: keep
    - source_labels: ['__journal__systemd_unit']
      target_label: 'unit'
    - source_labels: ['__journal_priority']
      target_label: 'priority'
    - source_labels: ['__journal__hostname']
      target_label: 'nodename'
