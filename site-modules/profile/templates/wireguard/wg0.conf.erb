# WireGuard VPN Server Configuration
# Managed by Puppet - DO NOT EDIT MANUALLY

[Interface]
PrivateKey = <%= @server_private_key %>
Address = <%= @vpn_server_ip %>/<%= @vpn_network.split('/')[1] %>
ListenPort = <%= @listen_port %>
# SaveConfig must be false when using Puppet to avoid config drift
# Puppet is the source of truth for configuration, not WireGuard runtime state
SaveConfig = false

<% if @enable_ip_forward -%>
# Enable IP forwarding
PreUp = sysctl -w net.ipv4.ip_forward=1
<% end -%>

<% if @enable_nat -%>
# UFW route rules and NAT configuration for VPN traffic
PostUp = ufw route allow in on <%= @interface_name %> out on <%= @external_interface %>
PostUp = iptables -t nat -I POSTROUTING -o <%= @external_interface %> -j MASQUERADE
PreDown = ufw route delete allow in on <%= @interface_name %> out on <%= @external_interface %>
PreDown = iptables -t nat -D POSTROUTING -o <%= @external_interface %> -j MASQUERADE
<% end -%>

<% @peers.each do |peer_name, peer_config| -%>
# Peer: <%= peer_name %>
[Peer]
PublicKey = <%= peer_config['public_key'] %>
<% if peer_config.has_key?('preshared_key') -%>
PresharedKey = <%= peer_config['preshared_key'] %>
<% end -%>
AllowedIPs = <%= peer_config['allowed_ips'] %>
<% if peer_config.has_key?('persistent_keepalive') -%>
PersistentKeepalive = <%= peer_config['persistent_keepalive'] %>
<% end -%>

<% end -%>
