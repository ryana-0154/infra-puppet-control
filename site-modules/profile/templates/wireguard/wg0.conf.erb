# WireGuard VPN Server Configuration
# Managed by Puppet - DO NOT EDIT MANUALLY

[Interface]
PrivateKey = <%= @server_private_key %>
Address = <%= @_vpn_server_ip %>/<%= @_vpn_network.split('/')[1] %>
ListenPort = <%= @_listen_port %>
# SaveConfig must be false when using Puppet to avoid config drift
# Puppet is the source of truth for configuration, not WireGuard runtime state
SaveConfig = false

<% if @enable_ip_forward -%>
# Enable IP forwarding
PreUp = sysctl -w net.ipv4.ip_forward=1
<% end -%>

<% if @enable_nat -%>
# UFW route rules and NAT configuration for VPN traffic
PostUp = ufw route allow in on <%= @_interface_name %> out on <%= @_external_interface %>
PostUp = iptables -t nat -A POSTROUTING -o <%= @_external_interface %> -j MASQUERADE -m comment --comment "wireguard-<%= @_interface_name %>"
PreDown = ufw route delete allow in on <%= @_interface_name %> out on <%= @_external_interface %> || true
PreDown = iptables -t nat -D POSTROUTING -o <%= @_external_interface %> -j MASQUERADE -m comment --comment "wireguard-<%= @_interface_name %>" || true
<% end -%>

<% @peers.each do |peer_name, peer_config| -%>
# Peer: <%= peer_name %>
[Peer]
PublicKey = <%= peer_config['public_key'] %>
<% if peer_config.key?('preshared_key') -%>
PresharedKey = <%= peer_config['preshared_key'] %>
<% end -%>
AllowedIPs = <%= peer_config['allowed_ips'] %>
<% if peer_config.key?('persistent_keepalive') -%>
PersistentKeepalive = <%= peer_config['persistent_keepalive'] %>
<% end -%>

<% end -%>
